***********************************Get daily Risk Profiles*****************************/
/***********************************Parameter selections************************************/
//Portfolio
//Property Types
//Capital Structure 
//Investment Structure
//Current Risk Profile
//User

/******************************************************************************************/
//Benchmark info
//Benchmark Dates
%LET TRAILING_FIVE_YEAR = QUARTERENDDATE(%FIVE_YEARS+1);
%LET FOUR_YEARS_BEGIN = YEARBEGDATE(%FOUR_YEARS)-1;
%LET FOUR_YEARS_END = YEARENDDATE(%FOUR_YEARS);
%LET THREE_YEARS_END = YEARENDDATE(%THREE_YEARS);
%LET TWO_YEARS_END = YEARENDDATE(%TWO_YEARS);
%LET ONE_YEAR_END = YEARENDDATE(%ONE_YEAR);

/***********************Get a list of all quarters between end date and four years ago***/
%DEFINE QUARTER_END_FILTER;
%DEFINE REPORT_DATE;
%LET DATE = %ASOFDATE;
%DEFINE USE_FUNDINVESTORPOSITIONS;
%DEFINE USE_FUNDINVESTOROPERATIONS;
%DEFINE USE_INVESTOR_CURR;
%DEFINE FOF_INVESTOR_REPORT;
%LET IQID_FOF_FUND = %FUND

//%DEFINE DISPOSITION_FILTER;
//Pull in assets data
DATA WORK.T_ASSETS;
SET V_ASSETS;
COLUMN DISPOSITION_BEFORE TYPE = INTEGER;

/***************Make sure only one entry per entry date****************************/
SCENARIO_OPERATING_COMPANY;
SCENARIO_PED;
SCENARIO_PORTFOLIO;
SCENARIO_SINGLE_PROPERTY;

//Target Information
SCENARIO_STRATEGIC_ALLOCS_NEW
DATA T_TARGET_INFO 
SET V_SCENARIO_STRATEGIC_ALLOCS_NEW
V_SCENARIO_STRATEGIC_TARGETS

/***************************Asset Scenarios***************************************************/
ASSET_SCENARIOS
ASOFDATE_LOAN_TO_VALUE PHYSICAL_OCCUPANCY = ASOFDATE_PHYSICAL_OCCUPANCY VALUE = ASOFDATE_MATURITY_DATE
DIRECT_CAP_RATE = ASOFDATE_DIRECT_CAP_RATE NET_ASSET_VALUE = ASOFDATE_NET_ASSET_VALUE DISCOUNT_RATE = ASOFDATE_DISCOUNT_RATE SCENARIO_TYPE_NAME = ASOFDATE_SCENARIO_TYPE_NAME FUND_OWNERSHIP = ASOFDATE_FUND_OWNERSHIP))

WORK.T_ASSET_SCENARIOS(WHERE ENTRY_DATE = %PREVIOUS_QTR_END KEEP =
WORK.T_ASSET_SCENARIOS(WHERE ENTRY_DATE = %ONE_YEAR KEEP 
WORK.T_ASSET_SCENARIOS(WHERE ENTRY_DATE = %FOUR_YEARS KEEP

SCENARIO_TYPE
QUARTER_GAV_CHANGE = ASOFDATE_VALUE-PREVIOUS_QTR_END_VALUE;
IF ASOFDATE_SCENARIO_TYPE_NAME = "Operating Company" THEN
   IF PUBLIC_CO = "TRUE" THEN
   ELSE
      ASOFDATE_SCENARIO_TYPE_NAME = "Private Companies";
      ASOFDATE_SCENARIO_TYPE_NAME = "Preferred Equity/Debt" THEN
      ASOFDATE_SCENARIO_TYPE_NAME = INVESTMENT_STRUCTURE;

WORK.T_ASSETS
WHERE ASOFDATE_FUND_OWNERSHIP <> 1 AND DISPOSITION_BEFORE <> 1 AND ASOFDATE_VALUE >0) OUT = WORK.T_NON_100_PERCENT_OWNERSHIP;
IF PROPERTY_TYPE IN("Office","Apartment","Retail","Industrial","Various") THEN
   PROPERTY_TYPE_CLASS = PROPERTY_TYPE;
ELSE
   PROPERTY_TYPE_CLASS = "Specialty";

COLUMN SEASONED TYPE = STRING;
IF SWIB_SUBSCRIPTION_DATE <= YMD(YEAR(QUARTER_END_DATE)-3,MONTH(QUARTER_END_DATE),DAY(QUARTER_END_DATE)) THEN
   SEASONED = "Seasoned";
ELSE
   SEASONED = "Unseasoned";

DATA WORK.T_FUND_TRANSACTIONS;
V_SCENARIO_PARTNERSHIP_SUMMARY(KEEP = ENTRY_DATE FUND_IQID OVERALL_LEVERAGE_RATIO RENAME=(ENTRY_DATE=QUARTER_END_DATE));


/*****************************Page 18*********************/

//Debt Structure Translation table.   
//Portfolio Markets Transalation Table
//Fund Ownership for last five years
SCENARIO_PARTNERSHIP_SUMMARY
IF NET_ASSET_VALUE IS NOT NULL THEN
OWNERSHIP_PERCENTAGE = SWIB_ENDING_MARKET_VALUE_NAV2/NET_ASSET_VALUE;

WHERE ASOFDATE_SCENARIO_TYPE_NAME_ORIGINAL = "Preferred Equity/Debt" KEEP = ASSET INVESTMENT_STRUCTURE 
SWIB_GAV = ASOFDATE_VALUE*OWNERSHIP_PERCENTAGE;

DEBT_INVESTMENT_STRUCTURES_PERCENTAGE = SWIB_GAV/SWIB_GAV_SUM;


/****Leverage Ratio/Subordination Risk Ratio****/
VALUE = VALUE*OWNERSHIP_PERCENTAGE;
DEBT_SENIOR_IN_CC = DEBT_SENIOR_IN_CC*OWNERSHIP_PERCENTAGE;
NET_ASSET_VALUE = NET_ASSET_VALUE*OWNERSHIP_PERCENTAGE;
FINANCING_ON_OWED_POSITION = FINANCING_ON_OWED_POSITION*OWNERSHIP_PERCENTAGE;
LEVERAGE_RATIO = (GAV-NAV)/GAV;
EMBEDDED_LEVERAGE_RATIO = 1 - (NAV/(NAV+FINANCING_ON_OWED_POSITION+DEBT_SENIOR_IN_CC));

/****Market Exposure****/
WHERE MSA IS NOT NULL /* AND DISPOSITION_BEFORE <> 1*/) 
(RENAME=(ORIGINAL=MSA NEW = MSA_NEW));
GAV = GAV/GAV_TOTAL;


/************Top 10*********/
COMPLETION_DATE = ASSET_NAME INVESTMENT_STRUCTURE MSA VALUE CURRENT_LIFECYCLE PROPERTY_TYPE);
PERCENT_OF_TOTAL_GAV = VALUE/VALUE_SUM;
VALUE = VALUE/1000000;
BY DESCENDING VALUE;


/*******Property Type Exposure by GAV*****/
WHERE COMPLETION_DATE IN(%ASOFDATE,%ONE_YEAR,%TWO_YEARS,%THREE_YEARS,%FOUR_YEARS)) 
SUM VALUE(NAME = GAV);
PERCENTAGE_OF_TOTAL = GAV/GAV_SUM;
TYPE_EXPOSURE_GAV_18 OUT = 

PROPERTY_TYPE="Data Center";OUTPUT;
PROPERTY_TYPE="For-sale Residential";OUTPUT;
PROPERTY_TYPE="Infrastructure";OUTPUT;
PROPERTY_TYPE="Medical Facility";OUTPUT;
PROPERTY_TYPE="Self Storage";OUTPUT;
PROPERTY_TYPE="Senior Living";OUTPUT;
PROPERTY_TYPE="Student Housing";OUTPUT;
PROPERTY_TYPE="Entertainment / Leisure";OUTPUT;
PROPERTY_TYPE="Mixed Use";OUTPUT;
PROPERTY_TYPE="Timberland";OUTPUT;
PROPERTY_TYPE="Agriculture";OUTPUT;
PROPERTY_TYPE="";OUTPUT;

IF GAV_SUM IS NULL THEN
   PERCENTAGE_OF_TOTAL = 0;


/*******Lifecycle Exposure by GAV*****/

DATA WORK.PED_ASSET_DATA_LIFECYCLES;
ASSET_LIFECYCLES" 
BY CURRENT_LIFECYCLE;

LIFECYCLE_EXPOSURE_GAV_TOTALS;
BY COMPLETION_DATE;

/*****************************Page 7**********************/
SWIB_NAV = NET_ASSET_VALUE*OWNERSHIP_PERCENTAGE;
ORIGINAL_VALUE = VALUE;
VALUE = VALUE*OWNERSHIP_PERCENTAGE;
TRANSLATION_TYPE = "ASSET_TYPES" RENAME=(ORIGINAL=TRANS_MERGE NEW = ASSET_TYPE));
TRANSLATION_TYPE = "PROPERTY_TYPES" RENAME=(ORIGINAL=PROPERTY_TYPE NEW = PROPERTY_TYPE_NEW));
TRANSLATION_TYPE SORT WHERE (CURRENT_LIFECYCLE_NEW in ("Operating Companies") AND SCENARIO_TYPE_INT = 1) OR (CURRENT_LIFECYCLE_NEW <> "Operating Companies" AND (NOT(SCENARIO_TYPE_INT=1))));
MERGE WORK.ASSET_DATA(IN=IN1) WORK.T_TRANS_TABLE(WHERE TRANSLATION_TYPE = "ASSET_LIFECYCLES" RENAME=(ORIGINAL=CURRENT_LIFECYCLE NEW = CURRENT_LIFECYCLE_NEW));


//Asset level
ASSET_TYPE_DATA
BY COMPLETION_DATE_SERIAL = DATESERIAL(YEAR(COMPLETION_DATE),MONTH(COMPLETION_DATE),DAY(COMPLETION_DATE));
PERCENTAGE_OF_TOTAL = GAV/GAV_SUM;


//Fund level
FUND_TYPE
BY COMPLETION_DATE;


//Leverage ratio
LEVERAGE_RATIO_GAV = SWIB_ENDING_MARKET_VALUE_NAV2/(1-OVERALL_LEVERAGE_RATIO);
SUM DEBT_SENIOR_IN_CC_ORIGINAL(NAME = DEBT_SENIOR_IN_CC);

IF (TOTAL_GROSS_EXPOSURE+CASH_CASH_EQUIVALENTS+DEBT_SENIOR_IN_CC) <> 0 THEN
SUB_RR_PERCENTAGE = (TOTAL_FINANCE_BMTM+DEBT_SENIOR_IN_CC)/(TOTAL_GROSS_EXPOSURE+CASH_CASH_EQUIVALENTS+DEBT_SENIOR_IN_CC);

IF SUB_RR_PERCENTAGE <> 1 THEN
RR_GAV = SWIB_ENDING_MARKET_VALUE_NAV2/(1-SUB_RR_PERCENTAGE);

LEVERAGE_RATIO = 1 - (NAV/GAV);
SUB_RISK_RATIO = 1 - NAV/(RR_GAV);


//Debt Maturity Schedule
CURRENT_YEAR=CURRENT_YEAR*OWNERSHIP_PERCENTAGE;
YEARS_ELEVEN_PLUS=YEARS_ELEVEN_PLUS*OWNERSHIP_PERCENTAGE;


//***Leverage Analysis
//Current Lifecycle
CLASS CURRENT_LIFECYCLE_NEW;
SUM VALUE(NAME = GAV) SWIB_NAV(NAME = NAV);
LEVERAGE = 1-(NAV/GAV);


//Property Type
SUM VALUE(NAME = GAV) SWIB_NAV(NAME = NAV);
LEVERAGE = 1-(NAV/GAV);


//Asset Type
SUM VALUE(NAME = GAV) SWIB_NAV(NAME = NAV);
LEVERAGE = 1-(NAV/GAV);

RENAME=(CURRENT_LIFECYCLE_NEW=LABEL))
RENAME=(PROPERTY_TYPE_NEW=LABEL))
RENAME=(SCENARIO_TYPE_NAME=LABEL))


/*****************************Page 5**********************/
//Current Risk Profiles
IF RISKPROF = "VALUE" THEN
RISKPROF_REPORT = "Value";
ELSEIF RISKPROF = "CORE" THEN
RISKPROF_REPORT = "Core";
ELSEIF RISKPROF = "OPPOR" THEN
RISKPROF_REPORT = "Opportunistic";


//US/Non-US
CLASS US_NON_US;
SUM VALUE(NAME = VALUE);
PERCENTAGE_OF_TOTAL = VALUE/VALUE_SUM;


//Property Types
PROPERTY_TYPES;
SUM VALUE(NAME = VALUE);
PERCENTAGE_OF_TOTAL = VALUE/VALUE_SUM;


//Asset Types

ASSET_TYPE = "Structured Debt & Preferred Equity";
SUM VALUE(NAME = VALUE);
PERCENTAGE_OF_TOTAL = VALUE/VALUE_SUM;


//Lifecycles
//Group Land and Development like in sample report
WHERE CURRENT_LIFECYCLE_NEW IN("Land","Development") 
SUM VALUE(NAME = VALUE);
WHERE (NOT (CURRENT_LIFECYCLE_NEW IN("Land","Development")))
SUM VALUE(NAME = VALUE);

CURRENT_LIFECYCLE_NEW = "Land/Development"
PERCENTAGE_OF_TOTAL = VALUE/VALUE_SUM;


//Leverage Ratio
SUM LEVERAGE_RATIO_GAV(NAME=GAV) SWIB_ENDING_MARKET_VALUE_NAV2(NAME=NAV);
LEVERAGE_RATIO = (GAV-NAV)/GAV;


/*****************************Page 8**********************/
//Lifecycles Portfolio
CLASS CURRENT_LIFECYCLE_NEW COMPLETION_DATE;
SUM VALUE(NAME = VALUE);
PERCENTAGE_OF_TOTAL = VALUE/VALUE_SUM;
COMPLETION_DATE_SERIAL = DATESERIAL(YEAR(COMPLETION_DATE),MONTH(COMPLETION_DATE),DAY(COMPLETION_DATE));


//Lifecycles Equity
CURRENT_LIFECYCLE_NEW COMPLETION_DATE;
SUM VALUE(NAME = VALUE);
PERCENTAGE_OF_TOTAL = VALUE/VALUE_SUM;
COMPLETION_DATE_SERIAL = DATESERIAL(YEAR(COMPLETION_DATE),MONTH(COMPLETION_DATE),DAY(COMPLETION_DATE));


//Lifecycles Debt
CURRENT_LIFECYCLE_NEW
SUM VALUE(NAME = VALUE);
PERCENTAGE_OF_TOTAL = VALUE/VALUE_SUM;


/*****************************Page 4**********************/
//Capital Structure Grouping
   CAPITAL_STRUCTURE_GROUPING = "Private Equity";
ELSEIF 
      INVESTMENT_STRUCTURE IN("Preferred Equity","First Mortgage","Junior Mortgage","Mezzanine","Non-Performing Loan(s)",
       "Participating Mortgage","Convertible Debt","Bank Loan / Private Placement","Tax-Exempt Bonds","Derivative") 
       OR INVESTMENT_STRUCTURE IS NULL) THEN
          CAPITAL_STRUCTURE_GROUPING = "Private Debt";
ELSEIF (SCENARIO_TYPE_INT = 1 AND PUBLIC_CO = "TRUE") THEN
   CAPITAL_STRUCTURE_GROUPING = "Public Equity";
ELSEIF SCENARIO_TYPE_INT = 2 AND INVESTMENT_STRUCTURE IN("CMBS - Investment Grade","CMBS - Below Inv. Grade","CMBS - Unrated","CRE CDO - Investment Grade","CRE CDO - Below Inv. Grade","REIT Bonds") 
THEN
   CAPITAL_STRUCTURE_GROUPING = "Public Debt";


//Fund/SA grouping
FUND_INVESTMENT_TYPE IN("Open-end Fund","Closed-end Fund") 
 ELSEIF FUND_INVESTMENT_TYPE IN("Separate Account","Joint Venture") THEN
   FUND_SA_GROUPING = "Separate Accounts";


//Capital Structure
CAPITAL_STRUCTURES;
SUM VALUE(NAME = VALUE);
PERCENTAGE_OF_TOTAL = VALUE/VALUE_SUM;


//Fund/SA
CLASS FUND_SA_GROUPING;
SUM VALUE(NAME = VALUE);
PERCENTAGE_OF_TOTAL = VALUE/VALUE_SUM;


//Leverage ratios
IF RISKPROF = "VALUE" THEN
RISKPROF_REPORT = "Value";
ELSEIF RISKPROF = "CORE" THEN
RISKPROF_REPORT = "Core";
ELSEIF RISKPROF = "OPPOR" THEN
RISKPROF_REPORT = "Opportunistic";

SUM LEVERAGE_RATIO_GAV(NAME=GAV) SWIB_ENDING_MARKET_VALUE_NAV2(NAME=NAV);
LEVERAGE_RATIO = (GAV-NAV)/GAV;


//Land
CURRENT_LIFECYCLE_NEW;
SUM VALUE(NAME = VALUE);
PERCENTAGE_OF_TOTAL = VALUE/VALUE_SUM;
CURRENT_LIFECYCLE_NEW = "Land";
PERCENTAGE_OF_TOTAL = 0;

RENAME=(CAPITAL_STRUCTURE_GROUPING=LABEL))
RENAME=(FUND_SA_GROUPING=LABEL))
RENAME=(RISK_PROFILE=LABEL))
RENAME=(CURRENT_LIFECYCLE_NEW=LABEL))


/*****************************Pages 19,20,21**************/
//Page 19
TRADE_DATE BETWEEN(QUARTERENDDATE(%FIVE_YEARS+1)
SWIB_ENDING_MARKET_VALUE_NAV2 = INVESTMENT_VALUE2)) 
INCOME_EARNED2 = INCOME_EARNED_BEFORE_MANAGEMENT_FEE2 - ADVISORY_MANAGEMENT_FEE2;
INCOME_DISTRIBUTION2 = DISTRIBUTIONS_OF_INCOME2 + FEE_OFFSETS_INTEREST_CARRY_INCOME2;
APPRECIATION2 = APPRECIATION_BEFORE_PERFORMANCE_FEES2 - INCENTIVE_FEE2 - ACQUISITION_FEE2 - OTHER_FEE2;
NET_INVESTMENT_ACTIVITY2 = CONTRIBUTIONS2 - RETURN_OF_CAPITAL2 + INCOME_EARNED2 - INCOME_DISTRIBUTION2 + APPRECIATION2;
PROC SORT DATA = WORK.T_INCOME_STATEMENT_19 OUT = T_INCOME_STATEMENT_19;


//Page 20
FUND_TRANSACTIONS(WHERE OPTYPE_RAW = 5 AND TRADE_DATE BETWEEN(QUARTERENDDATE(%FIVE_YEARS+1),%ASOFDATE))
BY QUARTER_END_DATE_TRADE ORIGINAL_RISK_PROFILE;
INCOME_EARNED2 = INCOME_EARNED_BEFORE_MANAGEMENT_FEE2 - ADVISORY_MANAGEMENT_FEE2;
INCOME_DISTRIBUTION2 = DISTRIBUTIONS_OF_INCOME2 + FEE_OFFSETS_INTEREST_CARRY_INCOME2;
APPRECIATION2 = APPRECIATION_BEFORE_PERFORMANCE_FEES2 - INCENTIVE_FEE2 - ACQUISITION_FEE2 - OTHER_FEE2;
NET_INVESTMENT_ACTIVITY2 = CONTRIBUTIONS2 - RETURN_OF_CAPITAL2 + INCOME_EARNED2 - INCOME_DISTRIBUTION2 + APPRECIATION2;


//Page 21
T_FUND_TRANSACTIONS
RENAME = (SWIB_ENDING_MARKET_VALUE_NAV2 = INVESTMENT_VALUE2));
INCOME_EARNED2 = INCOME_EARNED_BEFORE_MANAGEMENT_FEE2 - ADVISORY_MANAGEMENT_FEE2;
INCOME_DISTRIBUTION2 = DISTRIBUTIONS_OF_INCOME2 + FEE_OFFSETS_INTEREST_CARRY_INCOME2;
APPRECIATION2 = APPRECIATION_BEFORE_PERFORMANCE_FEES2 - INCENTIVE_FEE2 - ACQUISITION_FEE2 - OTHER_FEE2;
NET_INVESTMENT_ACTIVITY2 = CONTRIBUTIONS2 - RETURN_OF_CAPITAL2 + INCOME_EARNED2 - INCOME_DISTRIBUTION2 + APPRECIATION2;


/*******************Page 6*************************************/
//Risk Profile by NAV

CLASS COMPLETION_DATE RISKPROF;
PERCENT_OF_TOTAL = SWIB_ENDING_MARKET_VALUE_NAV2/SWIB_ENDING_MARKET_VALUE_NAV2_SUM;


//Value/Opportunistic Exposure
//Unfunded commitments
REMAININGCOMMITMENT = COMMITMENT - (CAPITALCALLED_INSIDE+MANAGEMENTFEES_INSIDE+OTHERFEES_INSIDE) + REDRAWABLECAPITAL;
   RUNNING_REMAININGCOMMITMENT = LAG(RUNNING_REMAININGCOMMITMENT) + REMAININGCOMMITMENT;
LAST RUNNING_REMAININGCOMMITMENT(NAME = RUNNING_REMAININGCOMMITMENT) RUNNING_COMMITMENT(NAME = RUNNING_COMMITMENT);
PROC MEANS DATA = WORK.T_VALUE_OPPORTUNISTIC_EXPOSURE OUT = WORK.T_VALUE_OPPORTUNISTIC_EXPOSURE_GROUPING;
TOTAL_SUM = RUNNING_REMAININGCOMMITMENT+SWIB_ENDING_MARKET_VALUE_NAV2_BY_RISKPROF;
PERCENTAGE_OF_TOTAL_NAV =  SWIB_ENDING_MARKET_VALUE_NAV2/TOTAL_SUM;
PERCENTAGE_OF_TOTAL_REMAINING =  RUNNING_REMAININGCOMMITMENT/TOTAL_SUM;






